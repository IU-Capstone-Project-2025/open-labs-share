global
    log stdout format raw local0
    stats socket /tmp/haproxy.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  log-health-checks
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend http_front
    bind *:80

    # Route auth requests to Auth Service (must come before general API routing)
    acl path_auth path_beg /api/v1/auth
    use_backend auth_service if path_auth

    # Route ML service requests
    acl path_ml path_beg /api/v1/ml
    use_backend ml_service if path_ml

    # Route all other API requests to API Gateway
    acl path_api path_beg /api/v1
    use_backend api_gateway if path_api

    # Default: route everything else to frontend
    default_backend frontend

# Frontend backend with blue servers only
backend frontend
    server frontend-test-server frontend-test:5173 check

# API Gateway backend with blue servers only
backend api_gateway
    server api-gateway-test-server api-gateway-test:8080 check

# Auth Service backend with blue servers only
backend auth_service
    server auth-service-test-server auth-service-test:8081 check

# ML Service backend is disabled for tests
backend ml_service
    http-request deny deny_status 503

listen stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 10s
    stats admin if TRUE
