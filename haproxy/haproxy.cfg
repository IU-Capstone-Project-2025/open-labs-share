global
    log stdout format raw local0
    stats socket /tmp/haproxy.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  log-health-checks
    timeout connect 5000
    timeout client  50000
    timeout server  50000

resolvers docker_resolver
    nameserver dns 127.0.0.11:53

frontend http_front
    bind *:80

    # Route auth requests to Auth Service (must come before general API routing)
    acl path_auth path_beg /api/v1/auth
    use_backend auth_service if path_auth

    # Route ML service requests
    acl path_ml path_beg /api/v1/ml
    use_backend ml_service if path_ml

    # Route all other API requests to API Gateway
    acl path_api path_beg /api/v1
    use_backend api_gateway if path_api

    # Default: route everything else to frontend
    default_backend frontend

backend frontend
    server frontend-green frontend-green:5173 check resolvers docker_resolver init-addr none

backend api_gateway
    server api-gateway-green api-gateway-green:8080 check resolvers docker_resolver init-addr none

backend auth_service
    server auth-service-green auth-service-green:8081 check resolvers docker_resolver init-addr none

backend ml_service
    server ml-service-green ml-service-green:8082 check resolvers docker_resolver init-addr none

listen stats
    bind *:8404
    stats enable
    stats uri /
    stats refresh 10s
    stats admin if TRUE
